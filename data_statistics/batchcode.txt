#!/bin/bash
#SBATCH -p mcml-dgx-a100-40x8
#SBATCH --qos=mcml
#SBATCH --ntasks=1
#SBATCH --gres=gpu:1
#SBATCH -t 6:00:00

source /dss/dsshome1/09/ra47fey3/miniforge3/etc/profile.d/conda.sh
conda activate py39
python src/dannMain.py



####################################
PARTITION              AVAIL  TIMELIMIT  NODES  STATE NODELIST
lrz-v100x2*               up 14-00:00:0      4    mix gpu-[001-003,005]
lrz-hpe-p100x4            up 14-00:00:0      1    mix p100-001
lrz-dgx-1-p100x8          up 14-00:00:0      1    mix dgx-001
lrz-dgx-1-v100x8          up 14-00:00:0      1    mix dgx-002
lrz-dgx-a100-80x8         up 14-00:00:0      3    mix lrz-dgx-a100-[001,004-005]
lrz-dgx-a100-80x8         up 14-00:00:0      1  alloc lrz-dgx-a100-002
lrz-hgx-a100-80x4         up 14-00:00:0      4    mix lrz-hgx-a100-[002-005]
lrz-dgx-a100-40x8-mig     up 14-00:00:0      1    mix lrz-dgx-a100-003
lrz-hgx-h100-94x4         up 14-00:00:0     28    mix lrz-hgx-h100-[002-029]
lrz-hgx-h100-94x4         up 14-00:00:0      1  alloc lrz-hgx-h100-030
lrz-cpu                   up 14-00:00:0      6    mix cpu-[001,003-004,008-009,011]
lrz-cpu                   up 14-00:00:0      2  alloc cpu-[002,007]
lrz-cpu                   up 14-00:00:0      4   idle cpu-[005-006,010,012]
mcml-dgx-a100-40x8        up 14-00:00:0      8    mix mcml-dgx-[001-008]
mcml-hgx-a100-80x4        up 14-00:00:0     18    mix mcml-hgx-a100-[001-018]
mcml-hgx-a100-80x4-mig    up 14-00:00:0      2    mix mcml-hgx-a100-[019-020]
mcml-hgx-a100-80x4-mig    up 14-00:00:0      1   idle mcml-hgx-a100-021
mcml-hgx-h100-94x4        up 14-00:00:0     20    mix mcml-hgx-h100-[001-015,017-021]
mcml-hgx-h100-94x4        up 14-00:00:0      1  alloc mcml-hgx-h100-016
test-v100x2               up 14-00:00:0      1   idle gpu-004
test-hgx-a100-80x4        up 14-00:00:0      1  drain lrz-hgx-a100-001
test-hgx-h100-94x4        up 14-00:00:0      1  drain lrz-hgx-h100-001


        # 2-layer domain classifier
        self.domain_classifier = nn.Sequential(
            nn.Linear(hidden_dim, 512),
            nn.ReLU(),
            nn.Dropout(0.2),
            nn.Linear(512, 256),
            nn.ReLU(),
            nn.Linear(256, 1)
        ) 22021851
        changed LR_clip = 1e-6 LR_dannHead = 5e-4
        loss = class_loss + 1.5 * domain_loss # weighing domian loss more.
        